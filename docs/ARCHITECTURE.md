# Header Route Architecture

## Overview Diagram

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                         Kubernetes Cluster                         â”‚
                                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                    â”‚  â”‚                        POC Namespace                          â”‚  â”‚
                                    â”‚  â”‚                                                               â”‚  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚  â”‚
â”‚   Client    â”‚                     â”‚  â”‚  â”‚  HeaderRoute    â”‚                                          â”‚  â”‚
â”‚   (curl)    â”‚                     â”‚  â”‚  â”‚  CRDs           â”‚                                          â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                          â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â”‚ route-a   â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
       â”‚ HTTP Request               â”‚  â”‚  â”‚  â”‚ route-b   â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  header-route-        â”‚        â”‚  â”‚
       â”‚ with Header                â”‚  â”‚  â”‚  â”‚ route-c   â”‚  â”‚  watch  â”‚  controller           â”‚        â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                       â”‚        â”‚  â”‚
       â–¼                            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  - Lists all routes   â”‚        â”‚  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚                              â”‚  - Generates config   â”‚        â”‚  â”‚
â”‚   Envoy     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  - Updates ConfigMap  â”‚        â”‚  â”‚
â”‚   Proxy     â”‚  ConfigMap mount    â”‚  â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚             â”‚                     â”‚  â”‚                                          â”‚                    â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                     â”‚  â”‚                                          â”‚ update             â”‚  â”‚
â”‚ â”‚ Config  â”‚ â”‚                     â”‚  â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚ â”‚ envoy.  â”‚ â”‚                     â”‚  â”‚                              â”‚    ConfigMap          â”‚        â”‚  â”‚
â”‚ â”‚ json    â”‚ â”‚                     â”‚  â”‚                              â”‚    envoy-config       â”‚        â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                     â”‚  â”‚                              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚                              â”‚    â”‚ envoy.json    â”‚  â”‚        â”‚  â”‚
       â”‚                            â”‚  â”‚                              â”‚    â”‚               â”‚  â”‚        â”‚  â”‚
       â”‚ Route based                â”‚  â”‚                              â”‚    â”‚ - listeners   â”‚  â”‚        â”‚  â”‚
       â”‚ on X-App header            â”‚  â”‚                              â”‚    â”‚ - clusters    â”‚  â”‚        â”‚  â”‚
       â”‚                            â”‚  â”‚                              â”‚    â”‚ - routes      â”‚  â”‚        â”‚  â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â”‚
       â”‚                            â”‚  â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
       â”‚                            â”‚  â”‚                                                               â”‚  â”‚
       â–¼                            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚  â”‚                     Backend Services                     â”‚  â”‚  â”‚
â”‚   Header    â”‚                     â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚   Match?    â”‚                     â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚  â”‚  â”‚   App A     â”‚  â”‚   App B     â”‚  â”‚  Default Backendâ”‚  â”‚  â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”œâ”€â”€â”€ X-App: A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â–¶â”‚  {"app":"A"}â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”œâ”€â”€â”€ X-App: B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚  {"app":"B"}â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”œâ”€â”€â”€ X-Tenant: acme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â–¶â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â”‚                            â”‚  â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
       â””â”€â”€â”€ (no match) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚  {"error":...}  â”‚  â”‚  â”‚  â”‚
                                    â”‚  â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                 â”‚  â”‚  â”‚  â”‚
                                    â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
                                    â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
                                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
                                    â”‚  â”‚                                                               â”‚  â”‚
                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                    â”‚                                                                     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
1. User creates HeaderRoute CRD
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ apiVersion: routing.../v1  â”‚
   â”‚ kind: HeaderRoute          â”‚
   â”‚ spec:                      â”‚
   â”‚   headerName: X-App        â”‚
   â”‚   headerValue: A           â”‚
   â”‚   backend:                 â”‚
   â”‚     name: app-a            â”‚
   â”‚     port: 80               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
2. Controller watches and reconciles
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - List all HeaderRoutes    â”‚
   â”‚ - Sort by priority         â”‚
   â”‚ - Generate Envoy config    â”‚
   â”‚ - Update ConfigMap         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
3. Envoy reads ConfigMap
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - Volume mount              â”‚
   â”‚ - Hot reload config        â”‚
   â”‚ - Apply new routes         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
4. Traffic is routed
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ curl -H "X-App: A" :8080   â”‚
   â”‚         â”‚                  â”‚
   â”‚         â–¼                  â”‚
   â”‚ Envoy matches header       â”‚
   â”‚         â”‚                  â”‚
   â”‚         â–¼                  â”‚
   â”‚ Routes to app-a:80         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Repository Split

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     header-route-controller     â”‚     â”‚       header-route-poc          â”‚
â”‚                                 â”‚     â”‚                                 â”‚
â”‚  ğŸ“¦ Reusable Controller Code    â”‚     â”‚  ğŸ§ª Complete POC Environment    â”‚
â”‚                                 â”‚     â”‚                                 â”‚
â”‚  â”œâ”€â”€ api/v1alpha1/              â”‚     â”‚  â”œâ”€â”€ cluster/                   â”‚
â”‚  â”‚   â””â”€â”€ headerroute_types.go   â”‚     â”‚  â”‚   â””â”€â”€ kind.yaml              â”‚
â”‚  â”œâ”€â”€ controller/                â”‚     â”‚  â”œâ”€â”€ manifests/                 â”‚
â”‚  â”‚   â””â”€â”€ headerroute_ctrl.go    â”‚     â”‚  â”‚   â”œâ”€â”€ apps/                  â”‚
â”‚  â”œâ”€â”€ internal/envoy/            â”‚     â”‚  â”‚   â”œâ”€â”€ envoy/                 â”‚
â”‚  â”‚   â””â”€â”€ config.go              â”‚     â”‚  â”‚   â”œâ”€â”€ controller/            â”‚
â”‚  â”œâ”€â”€ config/                    â”‚     â”‚  â”‚   â””â”€â”€ routes/                â”‚
â”‚  â”‚   â”œâ”€â”€ crd/                   â”‚     â”‚  â”œâ”€â”€ scripts/                   â”‚
â”‚  â”‚   â””â”€â”€ rbac/                  â”‚     â”‚  â”‚   â”œâ”€â”€ setup.sh               â”‚
â”‚  â”œâ”€â”€ Dockerfile                 â”‚     â”‚  â”‚   â””â”€â”€ cleanup.sh             â”‚
â”‚  â””â”€â”€ README.md                  â”‚     â”‚  â””â”€â”€ test/                      â”‚
â”‚                                 â”‚     â”‚      â””â”€â”€ test.sh                â”‚
â”‚  âœ… Can be open-sourced         â”‚     â”‚                                 â”‚
â”‚  âœ… Version independently       â”‚     â”‚  âœ… Full working example        â”‚
â”‚  âœ… Import as library           â”‚     â”‚  âœ… Tutorial/Documentation      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
